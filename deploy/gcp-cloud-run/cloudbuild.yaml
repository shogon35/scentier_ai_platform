# =============================================================================
# Scentier AI Platform - Cloud Build Configuration
# =============================================================================
# This file configures automated builds and deployments to Cloud Run.
#
# Prerequisites:
# 1. Enable Cloud Build API: gcloud services enable cloudbuild.googleapis.com
# 2. Enable Cloud Run API: gcloud services enable run.googleapis.com
# 3. Grant Cloud Build the Cloud Run Admin role
# 4. Create secrets in Secret Manager for sensitive environment variables
#
# Manual trigger:
#   gcloud builds submit --config=deploy/gcp-cloud-run/cloudbuild.yaml .
#
# =============================================================================

substitutions:
  # Project and region settings (override via --substitutions)
  _PROJECT_ID: ${PROJECT_ID}
  _REGION: asia-northeast1
  _SERVICE_NAME: scentier-ai-platform
  _IMAGE_NAME: scentier-ai-platform

  # Repository settings
  _ARTIFACT_REGISTRY: ${_REGION}-docker.pkg.dev/${_PROJECT_ID}/scentier-ai

  # Cloud Run settings
  _MIN_INSTANCES: '0'
  _MAX_INSTANCES: '10'
  _MEMORY: '2Gi'
  _CPU: '2'
  _TIMEOUT: '300s'
  _CONCURRENCY: '80'

  # VPC Connector (optional, for Cloud SQL/Memorystore access)
  # _VPC_CONNECTOR: projects/${_PROJECT_ID}/locations/${_REGION}/connectors/scentier-vpc-connector

options:
  # Use high-CPU machine for faster builds
  machineType: 'E2_HIGHCPU_8'
  # Enable Kaniko for efficient layer caching
  logging: CLOUD_LOGGING_ONLY
  # Use dynamic substitutions
  dynamic_substitutions: true

steps:
  # ==========================================================================
  # Step 1: Build Docker image with Kaniko (for layer caching)
  # ==========================================================================
  - id: 'build-image'
    name: 'gcr.io/kaniko-project/executor:latest'
    args:
      - '--dockerfile=deploy/gcp-cloud-run/Dockerfile.cloudrun'
      - '--context=.'
      - '--destination=${_ARTIFACT_REGISTRY}/${_IMAGE_NAME}:${SHORT_SHA}'
      - '--destination=${_ARTIFACT_REGISTRY}/${_IMAGE_NAME}:latest'
      - '--cache=true'
      - '--cache-ttl=168h'
      - '--snapshotMode=redo'
      - '--compressed-caching=false'
    waitFor: ['-']

  # ==========================================================================
  # Step 2: Deploy to Cloud Run
  # ==========================================================================
  - id: 'deploy-cloud-run'
    name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image=${_ARTIFACT_REGISTRY}/${_IMAGE_NAME}:${SHORT_SHA}'
      - '--region=${_REGION}'
      - '--platform=managed'
      - '--allow-unauthenticated'  # Change to --no-allow-unauthenticated for IAP
      - '--min-instances=${_MIN_INSTANCES}'
      - '--max-instances=${_MAX_INSTANCES}'
      - '--memory=${_MEMORY}'
      - '--cpu=${_CPU}'
      - '--timeout=${_TIMEOUT}'
      - '--concurrency=${_CONCURRENCY}'
      - '--port=8080'
      - '--cpu-boost'
      - '--execution-environment=gen2'
      # Secret Manager references (create these secrets first)
      - '--set-secrets=MONGO_URI=scentier-mongo-uri:latest'
      - '--set-secrets=CREDS_KEY=scentier-creds-key:latest'
      - '--set-secrets=CREDS_IV=scentier-creds-iv:latest'
      - '--set-secrets=JWT_SECRET=scentier-jwt-secret:latest'
      - '--set-secrets=JWT_REFRESH_SECRET=scentier-jwt-refresh-secret:latest'
      - '--set-secrets=MEILI_MASTER_KEY=scentier-meili-key:latest'
      # Environment variables
      - '--set-env-vars=NODE_ENV=production'
      - '--set-env-vars=CONSOLE_JSON=true'
      - '--set-env-vars=TRUST_PROXY=1'
      - '--set-env-vars=NO_INDEX=true'
      - '--set-env-vars=APP_TITLE=Scentier AI Platform'
      - '--set-env-vars=ALLOW_REGISTRATION=false'
      - '--set-env-vars=ALLOW_SOCIAL_LOGIN=true'
      - '--set-env-vars=SEARCH=true'
      # Labels for organization
      - '--labels=app=scentier-ai,env=production,team=platform'
      # Uncomment if using VPC Connector for private resources
      # - '--vpc-connector=${_VPC_CONNECTOR}'
      # - '--vpc-egress=private-ranges-only'
    waitFor: ['build-image']

  # ==========================================================================
  # Step 3: Get deployed service URL
  # ==========================================================================
  - id: 'get-service-url'
    name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Deployment Complete ==="
        SERVICE_URL=$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')
        echo "Service URL: $${SERVICE_URL}"
        echo ""
        echo "Update your .env with:"
        echo "  DOMAIN_CLIENT=$${SERVICE_URL}"
        echo "  DOMAIN_SERVER=$${SERVICE_URL}"
    waitFor: ['deploy-cloud-run']

# Artifacts to keep
images:
  - '${_ARTIFACT_REGISTRY}/${_IMAGE_NAME}:${SHORT_SHA}'
  - '${_ARTIFACT_REGISTRY}/${_IMAGE_NAME}:latest'

# Build timeout (max 24h, default 10m)
timeout: '1800s'

# Optional: Add trigger configuration
# trigger:
#   branchName: 'main'
#   includedFiles:
#     - 'api/**'
#     - 'client/**'
#     - 'packages/**'
#     - 'deploy/gcp-cloud-run/**'
