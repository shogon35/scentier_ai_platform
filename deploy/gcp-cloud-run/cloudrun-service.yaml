# =============================================================================
# Scentier AI Platform - Cloud Run Service Configuration
# =============================================================================
# Declarative Cloud Run service configuration
#
# Usage:
#   gcloud run services replace deploy/gcp-cloud-run/cloudrun-service.yaml \
#     --region=asia-northeast1
#
# Prerequisites:
#   1. Create secrets in Secret Manager
#   2. Push container image to Artifact Registry
#   3. Configure IAM roles for service account
#
# =============================================================================
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: scentier-ai-platform
  labels:
    app: scentier-ai
    env: production
    team: platform
  annotations:
    run.googleapis.com/description: "Scentier AI Platform - Internal SaaS"
    run.googleapis.com/ingress: all  # Change to 'internal' for VPC-only access
    run.googleapis.com/launch-stage: GA
spec:
  template:
    metadata:
      annotations:
        # Scaling configuration
        autoscaling.knative.dev/minScale: "0"
        autoscaling.knative.dev/maxScale: "10"

        # Resource configuration
        run.googleapis.com/cpu-throttling: "false"
        run.googleapis.com/startup-cpu-boost: "true"
        run.googleapis.com/execution-environment: gen2

        # Session affinity (optional, for WebSocket/long connections)
        run.googleapis.com/sessionAffinity: "true"

        # VPC Connector (uncomment if using private resources)
        # run.googleapis.com/vpc-access-connector: projects/PROJECT_ID/locations/REGION/connectors/scentier-vpc-connector
        # run.googleapis.com/vpc-access-egress: private-ranges-only

        # Cloud SQL connection (if using Cloud SQL instead of MongoDB Atlas)
        # run.googleapis.com/cloudsql-instances: PROJECT_ID:REGION:INSTANCE_NAME

    spec:
      # Service account with necessary permissions
      serviceAccountName: scentier-ai-sa@PROJECT_ID.iam.gserviceaccount.com

      # Request timeout
      timeoutSeconds: 300

      # Container concurrency
      containerConcurrency: 80

      containers:
        - name: scentier-ai-platform
          # Update with your Artifact Registry image
          image: asia-northeast1-docker.pkg.dev/PROJECT_ID/scentier-ai/scentier-ai-platform:latest

          ports:
            - name: http1
              containerPort: 8080

          # Resource limits
          resources:
            limits:
              cpu: "2"
              memory: 2Gi
            requests:
              cpu: "1"
              memory: 1Gi

          # Health checks
          startupProbe:
            httpGet:
              path: /api/health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 10

          livenessProbe:
            httpGet:
              path: /api/health
              port: 8080
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3

          # Environment variables
          env:
            # Server configuration
            - name: NODE_ENV
              value: "production"
            - name: HOST
              value: "0.0.0.0"
            - name: CONSOLE_JSON
              value: "true"
            - name: TRUST_PROXY
              value: "1"
            - name: NO_INDEX
              value: "true"

            # Application settings
            - name: APP_TITLE
              value: "Scentier AI Platform"
            - name: ALLOW_REGISTRATION
              value: "false"
            - name: ALLOW_SOCIAL_LOGIN
              value: "true"
            - name: ALLOW_EMAIL_LOGIN
              value: "true"
            - name: ALLOW_SHARED_LINKS
              value: "false"
            - name: SEARCH
              value: "true"

            # Rate limiting
            - name: LIMIT_CONCURRENT_MESSAGES
              value: "true"
            - name: CONCURRENT_MESSAGE_MAX
              value: "3"

            # Debug (disable in production)
            - name: DEBUG_LOGGING
              value: "false"

            # AI endpoints (user-provided keys)
            - name: OPENAI_API_KEY
              value: "user_provided"
            - name: ANTHROPIC_API_KEY
              value: "user_provided"
            - name: GOOGLE_KEY
              value: "user_provided"

            # Secrets from Secret Manager
            - name: MONGO_URI
              valueFrom:
                secretKeyRef:
                  name: scentier-mongo-uri
                  key: latest
            - name: CREDS_KEY
              valueFrom:
                secretKeyRef:
                  name: scentier-creds-key
                  key: latest
            - name: CREDS_IV
              valueFrom:
                secretKeyRef:
                  name: scentier-creds-iv
                  key: latest
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: scentier-jwt-secret
                  key: latest
            - name: JWT_REFRESH_SECRET
              valueFrom:
                secretKeyRef:
                  name: scentier-jwt-refresh-secret
                  key: latest
            - name: MEILI_MASTER_KEY
              valueFrom:
                secretKeyRef:
                  name: scentier-meili-key
                  key: latest

            # Optional: Google OAuth (uncomment if using)
            # - name: GOOGLE_CLIENT_ID
            #   valueFrom:
            #     secretKeyRef:
            #       name: scentier-google-client-id
            #       key: latest
            # - name: GOOGLE_CLIENT_SECRET
            #   valueFrom:
            #     secretKeyRef:
            #       name: scentier-google-client-secret
            #       key: latest

          # Volume mounts for config files (if needed)
          # volumeMounts:
          #   - name: librechat-config
          #     mountPath: /app/librechat.yaml
          #     subPath: librechat.yaml
          #     readOnly: true

      # Volumes (if needed)
      # volumes:
      #   - name: librechat-config
      #     secret:
      #       secretName: scentier-librechat-config
      #       items:
      #         - key: librechat.yaml
      #           path: librechat.yaml

  # Traffic configuration
  traffic:
    - percent: 100
      latestRevision: true

---
# =============================================================================
# Optional: Meilisearch Service for Search
# =============================================================================
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: scentier-meilisearch
  labels:
    app: scentier-meilisearch
    env: production
  annotations:
    run.googleapis.com/ingress: internal-and-cloud-load-balancing
spec:
  template:
    metadata:
      annotations:
        autoscaling.knative.dev/minScale: "1"
        autoscaling.knative.dev/maxScale: "1"
        run.googleapis.com/cpu-throttling: "false"
        run.googleapis.com/execution-environment: gen2
    spec:
      containers:
        - name: meilisearch
          image: getmeili/meilisearch:v1.12.3
          ports:
            - containerPort: 7700
          resources:
            limits:
              cpu: "1"
              memory: 2Gi
          env:
            - name: MEILI_NO_ANALYTICS
              value: "true"
            - name: MEILI_ENV
              value: "production"
            - name: MEILI_MASTER_KEY
              valueFrom:
                secretKeyRef:
                  name: scentier-meili-key
                  key: latest
          # Note: Meilisearch data is ephemeral in Cloud Run
          # For persistent search, consider:
          # 1. Cloud Storage FUSE mount
          # 2. External Meilisearch service (Meilisearch Cloud)
          # 3. Alternative: Algolia or Elasticsearch
  traffic:
    - percent: 100
      latestRevision: true
